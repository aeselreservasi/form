<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login Admin - Aesel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="login-section" class="min-vh-100 d-flex justify-content-center align-items-center">
      <div class="card shadow" style="max-width: 400px; width: 100%">
        <div class="card-body">
          <h5 class="card-title mb-3 text-center">Login Admin</h5>
          <p class="text-muted text-center mb-4" style="font-size: 0.9rem">Silakan login untuk mengakses halaman admin.</p>
          <div id="login-error" class="alert alert-danger py-2 d-none" style="font-size: 0.85rem">Username atau password salah.</div>
          <form id="login-form">
            <div class="mb-3">
              <label class="form-label">Username</label>
              <input type="text" class="form-control" id="username" placeholder="Masukkan username" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" id="password" placeholder="Masukkan password" required />
            </div>
            <button type="submit" class="btn btn-primary w-100">Login</button>
          </form>
        </div>
      </div>
    </div>
    <div id="admin-section" class="wrapper d-none">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-0">Data Reservasi Ujian - Aesel Reservasi</h5>
          </div>
          <div class="d-flex align-items-center gap-2">
            <select class="form-select form-select-sm" id="filter-layanan" style="width: auto">
              <option value="ALL">Semua Layanan</option>
              <option value="reservasi">Reservasi</option>
              <option value="reschedule">Reschedule</option>
            </select>
            <select class="form-select form-select-sm" id="filter-status" style="width: auto">
              <option value="ALL">Semua Status</option>
              <option value="BELUM BAYAR">Belum Bayar</option>
              <option value="PENDING">Pending</option>
              <option value="SETTLEMENT">Settlement (Lunas)</option>
              <option value="CANCEL">Cancel / Gagal</option>
            </select>
            <button class="btn btn-sm btn-download-all" id="btn-download-all">Download Semua</button>
            <button class="btn btn-danger btn-sm" id="btn-logout">Logout</button>
          </div>
        </div>
        <div class="card-body">
          <div id="status" class="mb-2 text-muted" style="font-size: 0.85rem">Memuat data dari Supabase...</div>
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle" id="data-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Nama Lengkap</th>
                  <th>Jenis Ujian</th>
                  <th>Lokasi</th>
                  <th>Tanggal Ujian</th>
                  <th>Jam</th>
                  <th>Status Bayar</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <form id="edit-form">
            <div class="modal-header">
              <h5 class="modal-title">Edit Data Reservasi</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="edit-id" />
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Nama Lengkap</label>
                  <input type="text" class="form-control" id="edit-nama" required />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Nomor Telepon</label>
                  <input type="text" class="form-control" id="edit-telepon" required />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Jenis Ujian</label>
                  <select class="form-select" id="edit-jenis-ujian" required>
                    <option value="">-- Pilih Jenis Ujian --</option>
                    <option value="JFT">JFT Basic A2</option>
                    <option value="PM">PM (Pengolahan Makanan)</option>
                    <option value="RESTO">RESTORAN</option>
                    <option value="KGINDO">Kaigo Indonesia</option>
                    <option value="KGJAPAN">Kaigo Jepang</option>
                    <option value="PERTANIAN">PERTANIAN</option>
                    <option value="PETERNAKAN">PETERNAKAN</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">ID Prometrik</label>
                  <input type="text" class="form-control" id="edit-id-prometrik" required />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Password</label>
                  <input type="text" class="form-control" id="edit-password" required />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Tanggal Lahir</label>
                  <input type="date" class="form-control" id="edit-tgl-lahir" />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Jenis Kelamin</label>
                  <select class="form-select" id="edit-jenis-kelamin">
                    <option value="">-- Pilih --</option>
                    <option value="Laki-laki">Laki-laki</option>
                    <option value="Perempuan">Perempuan</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Lokasi Ujian</label>
                  <input type="text" class="form-control" id="edit-lokasi" />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Tanggal Ujian</label>
                  <input type="date" class="form-control" id="edit-tanggal-ujian" required />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Jam Ujian (format sesi)</label>
                  <input type="text" class="form-control" id="edit-jam-ujian" placeholder="09:15,10:00,10:45,11:30" required />
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <span class="text-muted me-auto" style="font-size: 0.8rem">Pastikan data sudah benar sebelum menyimpan.</span>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
              <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const loginSection = document.getElementById("login-section");
        const adminSection = document.getElementById("admin-section");
        const loginForm = document.getElementById("login-form");
        const loginError = document.getElementById("login-error");
        const logoutBtn = document.getElementById("btn-logout");
        const EDGE_FUNCTION_URL = "https://lkygitfyhtvpspnhtyja.supabase.co/functions/v1/login";
        if (localStorage.getItem("aesel_admin_session") === "true") {
          loginSection.classList.add("d-none");
          adminSection.classList.remove("d-none");
        }
        loginForm.addEventListener("submit", async function (e) {
          e.preventDefault();
          loginError.classList.add("d-none");
          const username = document.getElementById("username").value.trim();
          const password = document.getElementById("password").value.trim();
          try {
            const res = await fetch(EDGE_FUNCTION_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username, password }),
            });
            const data = await res.json();
            if (!res.ok || !data.success) {
              loginError.textContent = data.error || "Login gagal";
              loginError.classList.remove("d-none");
              return;
            }
            localStorage.setItem("aesel_admin_session", "true");
            loginSection.classList.add("d-none");
            adminSection.classList.remove("d-none");
          } catch (err) {
            console.error(err);
            loginError.textContent = "Terjadi kesalahan jaringan";
            loginError.classList.remove("d-none");
          }
        });
        logoutBtn?.addEventListener("click", function () {
          localStorage.removeItem("aesel_admin_session");
          adminSection.classList.add("d-none");
          loginSection.classList.remove("d-none");
        });
      });
    </script>
    <script src="script.js"></script>
  </body>
</html>
